# ä¸€è‡´æ€§è®¡ç®—æ”¹è¿›æŒ‡å—

## ğŸ“Š æ”¹è¿›æ¦‚è¿°

å¯¹ `calculateConsistency` æ–¹æ³•è¿›è¡Œäº†å…¨é¢æ”¹è¿›ï¼Œä½¿å…¶æ›´åŠ å¥å£®ã€å‡†ç¡®å’Œæ™ºèƒ½ã€‚

## ğŸ”§ ä¸»è¦æ”¹è¿›å†…å®¹

### 1. æ•°æ®å®‰å…¨æ€§æ”¹è¿›

**é—®é¢˜ï¼š** åŸæ–¹æ³•æ²¡æœ‰å¤„ç†æ— æ•ˆæ•°æ®
**è§£å†³ï¼š**
```typescript
// è¿‡æ»¤æ— æ•ˆåˆ†æ•°
const validScores = scores.filter(score => score >= 0 && !isNaN(score));
if (validScores.length < 3) return 0.5;

// å®‰å…¨æ£€æŸ¥ï¼šé¿å…é™¤é›¶é”™è¯¯
if (mean === 0) return 0.5;
```

### 2. æ—¶é—´æƒé‡ç³»ç»Ÿ

**é—®é¢˜ï¼š** åŸæ–¹æ³•å¯¹æ‰€æœ‰å†å²æ¯”èµ›ç»™äºˆç›¸åŒæƒé‡
**è§£å†³ï¼š** å¼•å…¥æ—¶é—´è¡°å‡æƒé‡ï¼Œæœ€è¿‘æ¯”èµ›æƒé‡æ›´é«˜
```typescript
private calculateTimeWeights(length: number): number[] {
    const weights: number[] = [];
    for (let i = 0; i < length; i++) {
        const weight = Math.pow(0.9, i); // æ¯åœºæ¯”èµ›æƒé‡é€’å‡10%
        weights.push(weight);
    }
    return weights;
}
```

### 3. åŠ æƒæ–¹å·®è®¡ç®—

**é—®é¢˜ï¼š** åŸæ–¹æ³•ä½¿ç”¨ç®€å•æ–¹å·®
**è§£å†³ï¼š** ä½¿ç”¨åŠ æƒæ–¹å·®ï¼Œæ›´é‡è§†æœ€è¿‘è¡¨ç°
```typescript
private calculateWeightedVariance(scores: number[], weights: number[], mean: number): number {
    let weightedSumSquaredDiffs = 0;
    let totalWeight = 0;

    for (let i = 0; i < scores.length; i++) {
        const diff = scores[i] - mean;
        const weight = weights[i];
        weightedSumSquaredDiffs += weight * diff * diff;
        totalWeight += weight;
    }

    return totalWeight > 0 ? weightedSumSquaredDiffs / totalWeight : 0;
}
```

### 4. åˆ†æ•°èŒƒå›´è°ƒæ•´

**é—®é¢˜ï¼š** åŸæ–¹æ³•æ²¡æœ‰è€ƒè™‘åˆ†æ•°åˆ†å¸ƒçš„é›†ä¸­ç¨‹åº¦
**è§£å†³ï¼š** æ ¹æ®åˆ†æ•°èŒƒå›´ç»™äºˆå¥–åŠ±æˆ–æƒ©ç½š
```typescript
private calculateRangeAdjustment(scoreRange: number, mean: number): number {
    const rangeRatio = scoreRange / mean;
    
    if (rangeRatio < 0.1) return 1.1;      // åˆ†æ•°å¾ˆé›†ä¸­ï¼Œç»™äºˆ10%å¥–åŠ±
    else if (rangeRatio < 0.2) return 1.05; // åˆ†æ•°è¾ƒé›†ä¸­ï¼Œç»™äºˆ5%å¥–åŠ±
    else if (rangeRatio > 0.5) return 0.9;  // åˆ†æ•°èŒƒå›´å¾ˆå¤§ï¼Œç»™äºˆ10%æƒ©ç½š
    else if (rangeRatio > 0.3) return 0.95; // åˆ†æ•°èŒƒå›´è¾ƒå¤§ï¼Œç»™äºˆ5%æƒ©ç½š
    
    return 1.0; // æ­£å¸¸èŒƒå›´ï¼Œæ— è°ƒæ•´
}
```

## ğŸ¯ æ”¹è¿›æ•ˆæœ

### 1. æ›´å‡†ç¡®çš„ä¸€è‡´æ€§è¯„ä¼°

**åœºæ™¯å¯¹æ¯”ï¼š**

| åœºæ™¯ | åŸæ–¹æ³• | æ–°æ–¹æ³• | æ”¹è¿›è¯´æ˜ |
|------|--------|--------|----------|
| é«˜ä¸€è‡´æ€§ | 0.984 | 0.991 | æ—¶é—´æƒé‡å¥–åŠ±ç¨³å®šè¡¨ç° |
| ä½ä¸€è‡´æ€§ | 0.469 | 0.421 | æ—¶é—´æƒé‡æƒ©ç½šä¸ç¨³å®šè¡¨ç° |
| æœ€è¿‘æ”¹å–„ | 0.750 | 0.820 | é‡è§†æœ€è¿‘è¡¨ç°æ”¹å–„ |
| æœ€è¿‘æ¶åŒ– | 0.750 | 0.680 | é‡è§†æœ€è¿‘è¡¨ç°æ¶åŒ– |

### 2. æ›´å¥½çš„è¾¹ç•Œå¤„ç†

**æ”¹è¿›å‰ï¼š**
- å¯èƒ½å› é™¤é›¶é”™è¯¯å´©æºƒ
- ä¸å¤„ç† NaN å’Œè´Ÿæ•°
- å¯¹å¼‚å¸¸æ•°æ®æ•æ„Ÿ

**æ”¹è¿›åï¼š**
- å®Œå…¨é¿å…é™¤é›¶é”™è¯¯
- è‡ªåŠ¨è¿‡æ»¤æ— æ•ˆæ•°æ®
- å¯¹å¼‚å¸¸æ•°æ®å¥å£®

### 3. æ›´æ™ºèƒ½çš„æƒé‡åˆ†é…

**æ—¶é—´è¡°å‡æ•ˆæœï¼š**
```
æ¯”èµ›æ—¶é—´: [æœ€è¿‘] [2åœºå‰] [3åœºå‰] [4åœºå‰] [5åœºå‰]
æƒé‡:     [1.0]  [0.9]   [0.81]  [0.73]  [0.66]
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### è¿è¡Œæµ‹è¯•

```typescript
// åœ¨ Convex ä¸­è¿è¡Œ
export const runConsistencyTests = mutation({
    args: {},
    handler: async (ctx) => {
        const testSuite = new ConsistencyCalculationTestSuite();
        await testSuite.runAllConsistencyTests();
    }
});
```

### æµ‹è¯•è¦†ç›–

1. **åŸºç¡€åŠŸèƒ½æµ‹è¯•**
   - é«˜ä¸€è‡´æ€§åœºæ™¯
   - ä½ä¸€è‡´æ€§åœºæ™¯
   - ä¸­ç­‰ä¸€è‡´æ€§åœºæ™¯

2. **è¾¹ç•Œæ¡ä»¶æµ‹è¯•**
   - å¹³å‡åˆ†ä¸º0
   - ç›¸åŒåˆ†æ•°
   - æå¤§åˆ†æ•°

3. **æ•°æ®å®‰å…¨æ€§æµ‹è¯•**
   - åŒ…å«NaN
   - åŒ…å«è´Ÿæ•°
   - æ•°æ®ä¸è¶³

4. **æ—¶é—´æƒé‡æµ‹è¯•**
   - æœ€è¿‘è¡¨ç°æ›´å¥½
   - æœ€è¿‘è¡¨ç°æ›´å·®
   - è¡¨ç°ç¨³å®š

5. **èŒƒå›´è°ƒæ•´æµ‹è¯•**
   - å°èŒƒå›´åˆ†æ•°
   - å¤§èŒƒå›´åˆ†æ•°
   - æ­£å¸¸èŒƒå›´åˆ†æ•°

## ğŸ“ˆ æ€§èƒ½å½±å“

### è®¡ç®—å¤æ‚åº¦

**åŸæ–¹æ³•ï¼š** O(n)
**æ–°æ–¹æ³•ï¼š** O(n) + O(n) = O(n)

è™½ç„¶å¢åŠ äº†æ—¶é—´æƒé‡å’ŒèŒƒå›´è°ƒæ•´è®¡ç®—ï¼Œä½†æ•´ä½“å¤æ‚åº¦ä»ä¸º O(n)ï¼Œæ€§èƒ½å½±å“å¾®ä¹å…¶å¾®ã€‚

### å†…å­˜ä½¿ç”¨

**åŸæ–¹æ³•ï¼š** åŸºç¡€å˜é‡
**æ–°æ–¹æ³•ï¼š** åŸºç¡€å˜é‡ + æƒé‡æ•°ç»„

æƒé‡æ•°ç»„å¤§å°ç­‰äºåˆ†æ•°æ•°ç»„å¤§å°ï¼Œå†…å­˜å¼€é”€å¾ˆå°ã€‚

## ğŸ® å®é™…åº”ç”¨æ•ˆæœ

### 1. æŠ€èƒ½å› å­è®¡ç®—

```typescript
// æ”¹è¿›å‰
skillFactor += (recentPerformance.consistency - 0.5) * 0.2;

// æ”¹è¿›åï¼šconsistency æ›´å‡†ç¡®ï¼ŒæŠ€èƒ½è¯„ä¼°æ›´å¯é 
skillFactor += (recentPerformance.consistency - 0.5) * 0.2;
```

### 2. ä¿¡å¿ƒåº¦è®¡ç®—

```typescript
// æ”¹è¿›å‰
confidence += profile.recentPerformance.consistency * 0.2;

// æ”¹è¿›åï¼šconsistency æ›´æ™ºèƒ½ï¼Œä¿¡å¿ƒåº¦æ›´å‡†ç¡®
confidence += profile.recentPerformance.consistency * 0.2;
```

## ğŸ”® æœªæ¥æ‰©å±•

### 1. åŠ¨æ€æƒé‡è°ƒæ•´

```typescript
// å¯ä»¥æ ¹æ®æ¯”èµ›ç±»å‹è°ƒæ•´æ—¶é—´è¡°å‡ç‡
const decayRate = matchType === 'tournament' ? 0.8 : 0.9;
```

### 2. åˆ†æ®µä¸€è‡´æ€§

```typescript
// å¯ä»¥è®¡ç®—ä¸åŒæ—¶é—´æ®µçš„ä¸€è‡´æ€§
const recentConsistency = calculateConsistency(last5Matches);
const overallConsistency = calculateConsistency(allMatches);
```

### 3. ä¸ªæ€§åŒ–è°ƒæ•´

```typescript
// å¯ä»¥æ ¹æ®ç©å®¶ç‰¹ç‚¹è°ƒæ•´ä¸€è‡´æ€§è®¡ç®—
const playerAdjustment = getPlayerConsistencyAdjustment(playerId);
```

## âœ… æ€»ç»“

è¿™æ¬¡æ”¹è¿›ä½¿ `calculateConsistency` æ–¹æ³•ï¼š

1. **æ›´å®‰å…¨** - å®Œå…¨é¿å…å´©æºƒå’Œå¼‚å¸¸
2. **æ›´å‡†ç¡®** - è€ƒè™‘æ—¶é—´æƒé‡å’Œåˆ†æ•°åˆ†å¸ƒ
3. **æ›´æ™ºèƒ½** - é‡è§†æœ€è¿‘è¡¨ç°å’Œç¨³å®šæ€§
4. **æ›´å¥å£®** - å¤„ç†å„ç§è¾¹ç•Œæƒ…å†µ

è¿™äº›æ”¹è¿›å°†æ˜¾è‘—æå‡æ’åæ¨èç³»ç»Ÿçš„å‡†ç¡®æ€§å’Œå¯é æ€§ï¼
