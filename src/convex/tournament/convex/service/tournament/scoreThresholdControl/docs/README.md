# åˆ†æ•°é—¨æ§›æ§åˆ¶ç³»ç»Ÿ (Score Threshold Control System)

## ç³»ç»Ÿæ¦‚è¿°

åˆ†æ•°é—¨æ§›æ§åˆ¶ç³»ç»Ÿæ˜¯ä¸€ä¸ªæ™ºèƒ½åŒ–çš„ç©å®¶æ’åå’Œä½“éªŒç®¡ç†ç³»ç»Ÿï¼Œä¸“ä¸º 1 äººç±»ç©å®¶ vs N-1 AI ç©å®¶çš„æ¯”èµ›åœºæ™¯è®¾è®¡ã€‚ç³»ç»Ÿé€šè¿‡åˆ†æç©å®¶å†å²æ•°æ®ï¼ŒåŠ¨æ€è°ƒæ•´é…ç½®å‚æ•°ï¼Œæä¾›ä¸ªæ€§åŒ–çš„æ¸¸æˆä½“éªŒã€‚

## æ ¸å¿ƒç‰¹æ€§

### ğŸ¯ æ™ºèƒ½æ’ååˆ†é…
- **åŠ¨æ€å‚ä¸è€…æ•°é‡æ”¯æŒ**: æ”¯æŒ 4äººã€6äººã€8äººç­‰ä¸åŒè§„æ¨¡çš„æ¯”èµ›
- **å¤šæ¨¡å¼æ’åç®—æ³•**: `score_based`ã€`segment_based`ã€`hybrid` ä¸‰ç§æ¨¡å¼
- **è‡ªé€‚åº”è°ƒæ•´**: åŸºäºç©å®¶è¡¨ç°å®æ—¶ä¼˜åŒ–æ’åç­–ç•¥

### ğŸ§  æ™ºèƒ½é…ç½®ä¼˜åŒ–
- **å†å²æ•°æ®åˆ†æ**: è‡ªåŠ¨åˆ†æèƒœç‡è¶‹åŠ¿ã€åˆ†æ•°ç¨³å®šæ€§ã€å­¦ä¹ æ›²çº¿
- **é…ç½®è‡ªåŠ¨æ›´æ–°**: æ™ºèƒ½è°ƒæ•´å­¦ä¹ ç‡ã€æ’åæ¨¡å¼ã€è‡ªé€‚åº”æ¨¡å¼
- **ä¸ªæ€§åŒ–ä½“éªŒ**: ä¸ºæ¯ä¸ªç©å®¶æä¾›å®šåˆ¶åŒ–çš„æ¸¸æˆä½“éªŒ

### ğŸ›¡ï¸ ä¿æŠ¤æœºåˆ¶
- **æ®µä½ä¿æŠ¤**: é˜²æ­¢ç©å®¶å¿«é€Ÿé™çº§
- **å®½é™æœŸæœºåˆ¶**: ç»™äºˆç©å®¶è°ƒæ•´å’Œæ¢å¤çš„æœºä¼š
- **åŠ¨æ€ä¿æŠ¤ç­‰çº§**: åŸºäºè¡¨ç°åŠ¨æ€è°ƒæ•´ä¿æŠ¤å¼ºåº¦

## ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒç»„ä»¶

```
ScoreThresholdPlayerController (ä¸»æ§åˆ¶å™¨)
â”œâ”€â”€ HistoricalDataAnalyzer (å†å²æ•°æ®åˆ†æå™¨)
â”œâ”€â”€ SegmentManager (æ®µä½ç®¡ç†å™¨)
â””â”€â”€ IntelligentExperienceManager (æ™ºèƒ½ä½“éªŒç®¡ç†å™¨)
```

### æ•°æ®æµ

```
æ¯”èµ›ç»“æŸ â†’ æ’åè®¡ç®— â†’ æ•°æ®æ›´æ–° â†’ å†å²åˆ†æ â†’ é…ç½®ä¼˜åŒ– â†’ ä½“éªŒæå‡
```

## æ ¸å¿ƒåŠŸèƒ½è¯¦è§£

### 1. æ’åè®¡ç®—ç³»ç»Ÿ

#### æ”¯æŒçš„æ¨¡å¼
- **`score_based`**: åŸºäºåˆ†æ•°çš„æ’åï¼Œé€‚åˆåˆ†æ•°å·®å¼‚æ˜æ˜¾çš„æ¯”èµ›
- **`segment_based`**: åŸºäºæ®µä½çš„æ’åï¼Œè€ƒè™‘ç©å®¶å½“å‰æ°´å¹³
- **`hybrid`**: æ··åˆæ¨¡å¼ï¼Œç»“åˆåˆ†æ•°å’Œæ®µä½çš„ä¼˜åŠ¿

#### åŠ¨æ€å‚ä¸è€…æ”¯æŒ
```typescript
// æ”¯æŒä¸åŒæ•°é‡çš„å‚ä¸è€…
const rankResult = await controller.getRankByScore(uid, score, participantCount);
// participantCount: 4, 6, 8, 10... ç­‰
```

### 2. å†å²æ•°æ®åˆ†æå™¨

#### åˆ†æç»´åº¦
- **èƒœç‡è¶‹åŠ¿**: æ¯”è¾ƒæœ€è¿‘10åœºä¸æ•´ä½“èƒœç‡ï¼Œè¯†åˆ«è¿›æ­¥/é€€æ­¥è¶‹åŠ¿
- **åˆ†æ•°ç¨³å®šæ€§**: è®¡ç®—åˆ†æ•°æ–¹å·®å’Œå˜å¼‚ç³»æ•°ï¼Œè¯„ä¼°è¡¨ç°ç¨³å®šæ€§
- **æ’ååˆ†å¸ƒ**: åˆ†ææ’ååˆ†å¸ƒæ¨¡å¼ï¼ˆå‰é‡ã€å¹³è¡¡ã€åé‡ï¼‰
- **å­¦ä¹ æ›²çº¿**: æ£€æµ‹å­¦ä¹ é€Ÿåº¦å’Œå¹³å°æœŸï¼Œä¼˜åŒ–å­¦ä¹ ç­–ç•¥

#### åˆ†æç¤ºä¾‹
```typescript
const analysis = await historicalDataAnalyzer.analyzePlayerHistory(uid);
// è¿”å›:
// {
//   learningRateAdjustment: 0.05,        // å­¦ä¹ ç‡è°ƒæ•´å»ºè®®
//   rankingModeSuggestion: 'hybrid',     // æ’åæ¨¡å¼å»ºè®®
//   adaptiveModeSuggestion: 'learning',  // è‡ªé€‚åº”æ¨¡å¼å»ºè®®
//   scoreThresholdAdjustments: [...],    // åˆ†æ•°é—¨æ§›è°ƒæ•´å»ºè®®
//   confidence: 0.85                     // åˆ†æç½®ä¿¡åº¦
// }
```

### 3. æ™ºèƒ½é…ç½®æ›´æ–°

#### è‡ªåŠ¨è§¦å‘æ¡ä»¶
- æ¯”èµ›ç»“æŸåè‡ªåŠ¨è§¦å‘
- éœ€è¦è‡³å°‘5åœºæ¯”èµ›çš„å†å²æ•°æ®
- åˆ†æç½®ä¿¡åº¦ â‰¥ 0.3

#### æ›´æ–°ç­–ç•¥
```typescript
// å­¦ä¹ ç‡è°ƒæ•´
if (winRateAnalysis.trend === 'improving' && learningCurveAnalysis.learningSpeed === 'fast') {
    learningRateAdjustment = 0.05; // å¢åŠ å­¦ä¹ ç‡
} else if (winRateAnalysis.trend === 'declining' || learningCurveAnalysis.plateauDetected) {
    learningRateAdjustment = -0.03; // é™ä½å­¦ä¹ ç‡
}

// æ’åæ¨¡å¼å»ºè®®
if (scoreStabilityAnalysis.stability === 'high' && rankingDistributionAnalysis.distribution === 'top_heavy') {
    rankingModeSuggestion = 'segment_based'; // ç¨³å®šä¸”è¡¨ç°å¥½çš„ç©å®¶
} else if (scoreStabilityAnalysis.stability === 'low') {
    rankingModeSuggestion = 'score_based'; // ä¸ç¨³å®šçš„ç©å®¶
}
```

## ä½¿ç”¨æ–¹æ³•

### 1. åŸºç¡€ä½¿ç”¨

#### åˆå§‹åŒ–æ§åˆ¶å™¨
```typescript
import { ScoreThresholdPlayerController } from './core/ScoreThresholdPlayerController';

const controller = new ScoreThresholdPlayerController(ctx);
```

#### è·å–ç©å®¶æ’å
```typescript
// å•ä¸ªç©å®¶æ’å
const rankResult = await controller.getRankByScore(uid, score, participantCount);

// æ‰¹é‡è·å–æ’å
const batchResults = await controller.getBatchRanksByScores(playerScores);
```

### 2. æ¯”èµ›å¤„ç†

#### å®Œæ•´æ¯”èµ›æµç¨‹
```typescript
const matchResult = await controller.processMatchEnd(matchId, playerScores);
// è‡ªåŠ¨å®Œæˆ:
// 1. æ’åè®¡ç®—
// 2. æ®µä½å˜åŒ–æ£€æŸ¥
// 3. æ•°æ®æ›´æ–°
// 4. æ™ºèƒ½é…ç½®ä¼˜åŒ–
```

#### æ¯”èµ›ç»“æœç»“æ„
```typescript
{
    matchId: string,
    rankings: RankingResult[],
    segmentChanges: any[],
    timestamp: string
}
```

### 3. é…ç½®ç®¡ç†

#### è·å–ç©å®¶é…ç½®
```typescript
const config = await controller.getPlayerConfig(uid);
// åŒ…å«: learningRate, adaptiveMode, rankingMode, scoreThresholds ç­‰
```

#### æ‰‹åŠ¨æ›´æ–°é…ç½®
```typescript
const result = await controller.updatePlayerConfigBasedOnHistory(uid);
if (result.updated) {
    console.log(`é…ç½®å·²æ›´æ–°: ${result.changes.length} é¡¹å˜æ›´`);
    console.log('å˜æ›´è¯¦æƒ…:', result.changes);
}
```

#### æ‰¹é‡é…ç½®æ›´æ–°
```typescript
const batchResult = await controller.batchUpdatePlayerConfigs([uid1, uid2, uid3]);
console.log(`æ‰¹é‡æ›´æ–°å®Œæˆ: ${batchResult.updated}/${batchResult.total} æˆåŠŸ`);
```

### 4. æ™ºèƒ½åŠŸèƒ½ä½¿ç”¨

#### è·å–ä¼˜åŒ–å»ºè®®
```typescript
const suggestions = await controller.getPlayerConfigOptimizationSuggestions(uid);
console.log('ä¼˜åŒ–å»ºè®®:', suggestions.suggestions);
```

#### æ®µä½å˜åŒ–æ£€æŸ¥
```typescript
const changeResult = await controller.checkSegmentChange(uid, 'promotion');
if (changeResult.shouldChange) {
    console.log('å¯ä»¥å‡çº§æ®µä½');
}
```

## é…ç½®å‚æ•°è¯´æ˜

### å­¦ä¹ ç‡ (learningRate)
- **èŒƒå›´**: 0.01 - 0.3
- **ä½œç”¨**: æ§åˆ¶ç©å®¶å­¦ä¹ æ–°ç­–ç•¥çš„é€Ÿåº¦
- **è°ƒæ•´ç­–ç•¥**: è¿›æ­¥å¿«æ—¶å¢åŠ ï¼Œé‡åˆ°ç“¶é¢ˆæ—¶é™ä½

### è‡ªé€‚åº”æ¨¡å¼ (adaptiveMode)
- **`static`**: é™æ€æ¨¡å¼ï¼Œé…ç½®å›ºå®šä¸å˜
- **`dynamic`**: åŠ¨æ€æ¨¡å¼ï¼Œæ ¹æ®è¡¨ç°å®æ—¶è°ƒæ•´
- **`learning`**: å­¦ä¹ æ¨¡å¼ï¼ŒåŸºäºå†å²æ•°æ®ä¼˜åŒ–

### æ’åæ¨¡å¼ (rankingMode)
- **`score_based`**: çº¯åˆ†æ•°æ’åï¼Œé€‚åˆç«æŠ€æ€§å¼ºçš„æ¯”èµ›
- **`segment_based`**: æ®µä½æ’åï¼Œè€ƒè™‘ç©å®¶æ°´å¹³å·®å¼‚
- **`hybrid`**: æ··åˆæ’åï¼Œå¹³è¡¡å…¬å¹³æ€§å’ŒæŒ‘æˆ˜æ€§

### åˆ†æ•°é—¨æ§› (scoreThresholds)
- **åŠ¨æ€è°ƒæ•´**: åŸºäºåˆ†æ•°ç¨³å®šæ€§è‡ªåŠ¨è°ƒæ•´
- **æ‰©å±•ç­–ç•¥**: ä¸ç¨³å®šæ—¶æ‰©å¤§èŒƒå›´ï¼Œç¨³å®šæ—¶æ”¶ç´§èŒƒå›´
- **ä¸ªæ€§åŒ–**: æ¯ä¸ªç©å®¶æ ¹æ®å†å²è¡¨ç°å®šåˆ¶

## æ•°æ®è¡¨ç»“æ„

### æ ¸å¿ƒæ•°æ®è¡¨
- **`score_threshold_configs`**: ç©å®¶é…ç½®è¡¨
- **`player_performance_metrics`**: æ€§èƒ½æŒ‡æ ‡è¡¨
- **`player_protection_status`**: ä¿æŠ¤çŠ¶æ€è¡¨
- **`player_match_records`**: æ¯”èµ›è®°å½•è¡¨
- **`match_results`**: æ¯”èµ›ç»“æœè¡¨

### ç´¢å¼•ä¼˜åŒ–
- **`by_uid`**: æŒ‰ç©å®¶IDæŸ¥è¯¢
- **`by_segment`**: æŒ‰æ®µä½æŸ¥è¯¢
- **`by_createdAt`**: æŒ‰æ—¶é—´æ’åº
- **`by_score`**: æŒ‰åˆ†æ•°æŸ¥è¯¢

## æ€§èƒ½ä¼˜åŒ–

### å¼‚æ­¥å¤„ç†
- é…ç½®æ›´æ–°å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡æ¯”èµ›ç»“æœè¿”å›
- æ‰¹é‡æ“ä½œæ”¯æŒï¼Œæé«˜å¤„ç†æ•ˆç‡
- é”™è¯¯éš”ç¦»ï¼Œå•ä¸ªç©å®¶å¤±è´¥ä¸å½±å“æ•´ä½“

### ç¼“å­˜ç­–ç•¥
- ç©å®¶é…ç½®ç¼“å­˜ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢
- å†å²æ•°æ®åˆ†æç»“æœç¼“å­˜ï¼Œé¿å…é‡å¤è®¡ç®—
- æ®µä½è§„åˆ™ç¼“å­˜ï¼Œæé«˜å“åº”é€Ÿåº¦

## é”™è¯¯å¤„ç†

### å®¹é”™æœºåˆ¶
- æ¯ä¸ªæ“ä½œéƒ½æœ‰ç‹¬ç«‹çš„é”™è¯¯å¤„ç†
- å¤±è´¥æ—¶æä¾›é»˜è®¤å€¼å’Œé™çº§ç­–ç•¥
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•

### æ¢å¤ç­–ç•¥
- é…ç½®æ›´æ–°å¤±è´¥æ—¶å›æ»šåˆ°ä¸Šæ¬¡æœ‰æ•ˆé…ç½®
- æ•°æ®ä¸ä¸€è‡´æ—¶è‡ªåŠ¨ä¿®å¤
- ç½‘ç»œå¼‚å¸¸æ—¶é‡è¯•æœºåˆ¶

## ç›‘æ§å’Œè°ƒè¯•

### æ€§èƒ½ç›‘æ§
- æ’åè®¡ç®—è€—æ—¶ç»Ÿè®¡
- é…ç½®æ›´æ–°æˆåŠŸç‡ç›‘æ§
- æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½åˆ†æ

### è°ƒè¯•å·¥å…·
- è¯¦ç»†çš„å˜æ›´æ—¥å¿—è®°å½•
- é…ç½®æ›´æ–°åŸå› è¿½è¸ª
- å†å²æ•°æ®åˆ†æç»“æœå±•ç¤º

## æœ€ä½³å®è·µ

### 1. é…ç½®æ›´æ–°æ—¶æœº
- æ¯”èµ›ç»“æŸåè‡ªåŠ¨è§¦å‘ï¼ˆæ¨èï¼‰
- å®šæœŸæ‰¹é‡æ›´æ–°ï¼ˆç³»ç»Ÿç»´æŠ¤ï¼‰
- æ‰‹åŠ¨è§¦å‘ï¼ˆç‰¹æ®Šéœ€æ±‚ï¼‰

### 2. å‚æ•°è°ƒä¼˜
- å­¦ä¹ ç‡è°ƒæ•´å¹…åº¦æ§åˆ¶åœ¨ 0.01-0.05
- ç½®ä¿¡åº¦é˜ˆå€¼è®¾ç½®ä¸º 0.3-0.5
- å†å²æ•°æ®è¦æ±‚è‡³å°‘ 5-10 åœºæ¯”èµ›

### 3. æ€§èƒ½è€ƒè™‘
- å¤§é‡ç©å®¶æ—¶ä½¿ç”¨æ‰¹é‡æ“ä½œ
- é…ç½®æ›´æ–°ä½¿ç”¨å¼‚æ­¥å¤„ç†
- å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®

## æ‰©å±•åŠŸèƒ½

### 1. è‡ªå®šä¹‰åˆ†æå™¨
```typescript
class CustomDataAnalyzer extends HistoricalDataAnalyzer {
    async analyzeCustomMetrics(uid: string) {
        // å®ç°è‡ªå®šä¹‰åˆ†æé€»è¾‘
    }
}
```

### 2. è‡ªå®šä¹‰é…ç½®ç­–ç•¥
```typescript
class CustomConfigStrategy {
    generateCustomSuggestions(analysis: any) {
        // å®ç°è‡ªå®šä¹‰é…ç½®å»ºè®®
    }
}
```

### 3. é›†æˆå¤–éƒ¨ç³»ç»Ÿ
- ä¸æ®µä½ç³»ç»Ÿæ·±åº¦é›†æˆ
- ä¸ä»»åŠ¡ç³»ç»Ÿè”åŠ¨
- ä¸å¥–åŠ±ç³»ç»Ÿç»“åˆ

## æ€»ç»“

åˆ†æ•°é—¨æ§›æ§åˆ¶ç³»ç»Ÿé€šè¿‡æ™ºèƒ½åŒ–çš„å†å²æ•°æ®åˆ†æå’Œé…ç½®ä¼˜åŒ–ï¼Œä¸ºæ¯ä¸ªç©å®¶æä¾›ä¸ªæ€§åŒ–çš„æ¸¸æˆä½“éªŒã€‚ç³»ç»Ÿå…·å¤‡é«˜åº¦çš„è‡ªåŠ¨åŒ–ç¨‹åº¦ï¼Œèƒ½å¤Ÿæ ¹æ®ç©å®¶è¡¨ç°å®æ—¶è°ƒæ•´ç­–ç•¥ï¼Œç¡®ä¿æ¸¸æˆçš„å…¬å¹³æ€§å’ŒæŒ‘æˆ˜æ€§ã€‚

é€šè¿‡åˆç†ä½¿ç”¨ç³»ç»Ÿçš„å„é¡¹åŠŸèƒ½ï¼Œå¯ä»¥æœ‰æ•ˆæå‡ç©å®¶ç•™å­˜ç‡ï¼Œåˆ›é€ æ›´å¥½çš„æ¸¸æˆä½“éªŒã€‚
