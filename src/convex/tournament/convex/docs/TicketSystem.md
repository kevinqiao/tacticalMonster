# ç®€åŒ–é—¨ç¥¨ç³»ç»Ÿæ–‡æ¡£ - æ— æ—¶æ•ˆè®¾è®¡

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

ç®€åŒ–é—¨ç¥¨ç³»ç»Ÿæ˜¯ä¸€ä¸ªè·¨æ¸¸æˆçš„ç»Ÿä¸€é—¨ç¥¨ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒä¸‰ç§åŸºæœ¬é—¨ç¥¨ç±»å‹ï¼š**é’é“œ(Bronze)**ã€**ç™½é“¶(Silver)**ã€**é»„é‡‘(Gold)**ã€‚é—¨ç¥¨æœ¬èº«æ²¡æœ‰æ—¶æ•ˆæ€§ï¼Œæ°¸ä¹…æœ‰æ•ˆç›´åˆ°ä½¿ç”¨ï¼Œé”¦æ ‡èµ›é…ç½®å†³å®šä½¿ç”¨å“ªç§é—¨ç¥¨ç±»å‹ã€‚

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### é—¨ç¥¨ç±»å‹
- **é’é“œé—¨ç¥¨**ï¼šæ–°æ‰‹å‹å¥½ï¼Œä»·æ ¼å®æƒ  (50é‡‘å¸)
- **ç™½é“¶é—¨ç¥¨**ï¼šè¿›é˜¶ç©å®¶ï¼Œå¹³è¡¡æ€§ä»·æ¯” (100é‡‘å¸)  
- **é»„é‡‘é—¨ç¥¨**ï¼šé«˜çº§ç©å®¶ï¼Œé¡¶çº§å¥–åŠ± (200é‡‘å¸)

### æ— æ—¶æ•ˆè®¾è®¡
- **é—¨ç¥¨æ°¸ä¹…æœ‰æ•ˆ**ï¼šè´­ä¹°åæ°¸ä¹…ä¿å­˜ï¼Œä¸ä¼šè¿‡æœŸ
- **é”¦æ ‡èµ›é…ç½®å†³å®š**ï¼šé”¦æ ‡èµ›ç±»å‹å†³å®šéœ€è¦å“ªç§é—¨ç¥¨
- **çµæ´»ä½¿ç”¨**ï¼šåŒä¸€å¼ é—¨ç¥¨å¯ç”¨äºä¸åŒé”¦æ ‡èµ›

### è·¨æ¸¸æˆæ”¯æŒ
- æ”¯æŒæ‰€æœ‰æ¸¸æˆç±»å‹ï¼šLudoã€Solitaireã€Rummyã€Uno
- ç»Ÿä¸€çš„é—¨ç¥¨ä½¿ç”¨æœºåˆ¶
- çµæ´»çš„æ¸¸æˆç±»å‹é…ç½®

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•°æ®è¡¨ç»“æ„

```typescript
// é—¨ç¥¨æ¨¡æ¿è¡¨
ticket_templates: {
    templateId: string,        // æ¨¡æ¿ID
    name: string,              // é—¨ç¥¨åç§°
    description: string,       // æè¿°
    type: "bronze" | "silver" | "gold",  // é—¨ç¥¨ç±»å‹
    price: { coins: number },  // ä»·æ ¼
    maxUsagePerDay: number,    // æ¯æ—¥æœ€å¤§ä½¿ç”¨æ¬¡æ•°
    gameTypes: string[],       // æ”¯æŒçš„æ¸¸æˆç±»å‹
    isActive: boolean          // æ˜¯å¦æ¿€æ´»
}

// ç©å®¶é—¨ç¥¨è¡¨
player_tickets: {
    uid: string,               // ç©å®¶ID
    templateId: string,        // æ¨¡æ¿ID
    quantity: number,          // æ•°é‡
    lastUsedAt?: string        // æœ€åä½¿ç”¨æ—¶é—´
}

// é—¨ç¥¨äº¤æ˜“è¡¨
ticket_transactions: {
    uid: string,               // ç©å®¶ID
    templateId: string,        // æ¨¡æ¿ID
    quantity: number,          // æ•°é‡
    transactionType: string,   // äº¤æ˜“ç±»å‹
    source: string,            // æ¥æº
    context?: any,             // ä¸Šä¸‹æ–‡
    createdAt: string          // åˆ›å»ºæ—¶é—´
}
```

### æ ¸å¿ƒæœåŠ¡ç±»

```typescript
export class TicketSystem {
    // é—¨ç¥¨æ¨¡æ¿ç®¡ç†
    static async getAllTicketTemplates(ctx: any): Promise<TicketTemplate[]>
    static async getTicketTemplatesByType(ctx: any, type: string): Promise<TicketTemplate[]>
    static async getTicketTemplatesByGameType(ctx: any, gameType: string): Promise<TicketTemplate[]>
    
    // ç©å®¶é—¨ç¥¨ç®¡ç†
    static async getPlayerTickets(ctx: any, uid: string): Promise<PlayerTicket[]>
    static async getPlayerValidTickets(ctx: any, uid: string): Promise<PlayerTicket[]>
    
    // é—¨ç¥¨è´­ä¹°å’Œä½¿ç”¨
    static async purchaseTicket(ctx: any, params: any): Promise<any>
    static async useTicket(ctx: any, params: any): Promise<any>
    
    // é—¨ç¥¨å¥–åŠ±
    static async grantTicketReward(ctx: any, params: any): Promise<any>
    
    // ç³»ç»Ÿç»´æŠ¤
    static async checkTicketEligibility(ctx: any, params: any): Promise<any>
}
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åˆå§‹åŒ–ç³»ç»Ÿ

```typescript
// åˆå§‹åŒ–é—¨ç¥¨ç³»ç»Ÿ
await initTicketSystem(ctx);

// æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
const status = await checkTicketSystemStatus(ctx);
console.log("é—¨ç¥¨æ¨¡æ¿æ•°é‡:", status.templates);
console.log("é—¨ç¥¨å¥—é¤æ•°é‡:", status.bundles);
```

### 2. è´­ä¹°é—¨ç¥¨

```typescript
// è´­ä¹°é’é“œé—¨ç¥¨
const result = await purchaseTicket(ctx, {
    uid: "player123",
    templateId: "bronze_ticket",
    quantity: 1,
    source: "shop"
});

if (result.success) {
    console.log("è´­ä¹°æˆåŠŸ:", result.message);
}
```

### 3. ä½¿ç”¨é—¨ç¥¨

```typescript
// ä½¿ç”¨é—¨ç¥¨å‚åŠ é”¦æ ‡èµ›
const result = await useTicket(ctx, {
    uid: "player123",
    templateId: "bronze_ticket",
    gameType: "ludo",
    tournamentId: "tournament456"
});

if (result.success) {
    console.log("é—¨ç¥¨ä½¿ç”¨æˆåŠŸï¼Œå‰©ä½™æ•°é‡:", result.remainingQuantity);
}
```

### 4. è·å–ç©å®¶é—¨ç¥¨

```typescript
// è·å–ç©å®¶æ‰€æœ‰é—¨ç¥¨
const tickets = await getPlayerTickets(ctx, "player123");

// è·å–ç©å®¶æœ‰æ•ˆé—¨ç¥¨ï¼ˆæ•°é‡å¤§äº0ï¼‰
const validTickets = await getPlayerValidTickets(ctx, "player123");

// è·å–ç‰¹å®šæ¸¸æˆç±»å‹çš„é—¨ç¥¨
const gameTickets = await getPlayerValidTicketsByGameType(ctx, "player123", "ludo");
```

## ğŸ’° ä»·æ ¼ä½“ç³»

### é—¨ç¥¨ä»·æ ¼
- **é’é“œé—¨ç¥¨**ï¼š50é‡‘å¸
- **ç™½é“¶é—¨ç¥¨**ï¼š100é‡‘å¸
- **é»„é‡‘é—¨ç¥¨**ï¼š200é‡‘å¸

### å¥—é¤ä»·æ ¼
- **æ–°æ‰‹å¥—é¤**ï¼š300é‡‘å¸ (5å¼ é’é“œ + 2å¼ ç™½é“¶)
- **è¿›é˜¶å¥—é¤**ï¼š800é‡‘å¸ (5å¼ ç™½é“¶ + 2å¼ é»„é‡‘)
- **ä¸“ä¸šå¥—é¤**ï¼š1200é‡‘å¸ (5å¼ é»„é‡‘ + 3å¼ ç™½é“¶)

## ğŸ“¦ é—¨ç¥¨å¥—é¤

### æ–°æ‰‹å¥—é¤ (300é‡‘å¸)
- 5å¼ é’é“œé—¨ç¥¨
- 2å¼ ç™½é“¶é—¨ç¥¨

### è¿›é˜¶å¥—é¤ (800é‡‘å¸)
- 5å¼ ç™½é“¶é—¨ç¥¨
- 2å¼ é»„é‡‘é—¨ç¥¨

### ä¸“ä¸šå¥—é¤ (1200é‡‘å¸)
- 5å¼ é»„é‡‘é—¨ç¥¨
- 3å¼ ç™½é“¶é—¨ç¥¨

## ğŸ”§ ä½¿ç”¨é™åˆ¶

### æ¯æ—¥ä½¿ç”¨é™åˆ¶
- **é’é“œé—¨ç¥¨**ï¼šæ¯æ—¥æœ€å¤šä½¿ç”¨3æ¬¡
- **ç™½é“¶é—¨ç¥¨**ï¼šæ¯æ—¥æœ€å¤šä½¿ç”¨5æ¬¡
- **é»„é‡‘é—¨ç¥¨**ï¼šæ¯æ—¥æœ€å¤šä½¿ç”¨10æ¬¡

### æ°¸ä¹…æœ‰æ•ˆ
- é—¨ç¥¨è´­ä¹°åæ°¸ä¹…æœ‰æ•ˆ
- ä¸ä¼šè¿‡æœŸï¼Œå¯éšæ—¶ä½¿ç”¨
- æ•°é‡ä¸º0æ—¶æ— æ³•ä½¿ç”¨

## ğŸ® æ¸¸æˆé›†æˆ

### é”¦æ ‡èµ›é…ç½®
é—¨ç¥¨ä½¿ç”¨åœ¨é”¦æ ‡èµ›é…ç½®ä¸­è®¾ç½®ï¼š

```typescript
// é”¦æ ‡èµ›ç±»å‹é…ç½®
{
    typeId: "daily_bronze_tournament",
    name: "é’é“œæ¯æ—¥é”¦æ ‡èµ›",
    entryRequirements: {
        ticketRequired: true,
        ticketTemplateId: "bronze_ticket"  // æŒ‡å®šéœ€è¦çš„é—¨ç¥¨ç±»å‹
    },
    // ... å…¶ä»–é…ç½®
}
```

### é—¨ç¥¨éªŒè¯æµç¨‹
1. ç©å®¶å°è¯•åŠ å…¥é”¦æ ‡èµ›
2. ç³»ç»Ÿæ£€æŸ¥é”¦æ ‡èµ›çš„é—¨ç¥¨è¦æ±‚
3. éªŒè¯ç©å®¶æ˜¯å¦æœ‰å¯¹åº”ç±»å‹çš„æœ‰æ•ˆé—¨ç¥¨
4. æ£€æŸ¥é—¨ç¥¨æ˜¯å¦é€‚ç”¨äºè¯¥æ¸¸æˆç±»å‹
5. æ‰£é™¤é—¨ç¥¨æ•°é‡å¹¶å…è®¸åŠ å…¥

## ğŸ“Š ç»Ÿè®¡å’Œåˆ†æ

### ä½¿ç”¨ç»Ÿè®¡
```typescript
// è·å–ç©å®¶é—¨ç¥¨ä½¿ç”¨ç»Ÿè®¡
const stats = await getPlayerTicketStats(ctx, "player123");
// è¿”å›ï¼šæ€»ä½¿ç”¨æ¬¡æ•°ã€èƒœåˆ©æ¬¡æ•°ã€å¤±è´¥æ¬¡æ•°ã€èƒœç‡ç­‰
```

### çƒ­é—¨é—¨ç¥¨
```typescript
// è·å–çƒ­é—¨é—¨ç¥¨æ¨¡æ¿
const popularTickets = await getPopularTicketTemplates(ctx);
// åŸºäºä½¿ç”¨ç»Ÿè®¡è¿”å›æœ€å—æ¬¢è¿çš„é—¨ç¥¨
```

### æ¨èç³»ç»Ÿ
```typescript
// ç”Ÿæˆç©å®¶é—¨ç¥¨æ¨è
await generateTicketRecommendations(ctx, "player123");

// è·å–æ¨èç»“æœ
const recommendations = await getPlayerTicketRecommendations(ctx, "player123");
```

## ğŸ› ï¸ ç³»ç»Ÿç»´æŠ¤

### å¥åº·æ£€æŸ¥
```typescript
// æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
const health = await ticketSystemHealthCheck(ctx);
if (health.success) {
    console.log("ç³»ç»ŸçŠ¶æ€:", health.status);
    console.log("ç»Ÿè®¡ä¿¡æ¯:", health.stats);
}
```

### äº¤æ˜“å†å²
```typescript
// è·å–é—¨ç¥¨äº¤æ˜“å†å²
const history = await getTicketTransactionHistory(ctx, {
    uid: "player123",
    limit: 50
});

// è·å–å¥—é¤è´­ä¹°å†å²
const bundleHistory = await getBundlePurchaseHistory(ctx, {
    uid: "player123",
    limit: 20
});
```

## ğŸ”’ å®‰å…¨æœºåˆ¶

### ä½¿ç”¨éªŒè¯
- éªŒè¯é—¨ç¥¨æ˜¯å¦å­˜åœ¨
- æ£€æŸ¥é—¨ç¥¨æ•°é‡æ˜¯å¦è¶³å¤Ÿ
- éªŒè¯æ¸¸æˆç±»å‹åŒ¹é…
- æ£€æŸ¥æ¯æ—¥ä½¿ç”¨é™åˆ¶

### äº¤æ˜“è®°å½•
- æ‰€æœ‰é—¨ç¥¨æ“ä½œéƒ½æœ‰å®Œæ•´è®°å½•
- æ”¯æŒäº¤æ˜“å†å²æŸ¥è¯¢
- ä¾¿äºé—®é¢˜æ’æŸ¥å’Œå®¡è®¡

### é˜²åˆ·æœºåˆ¶
- æ¯æ—¥ä½¿ç”¨æ¬¡æ•°é™åˆ¶
- é—¨ç¥¨æ•°é‡ç®¡ç†
- äº¤æ˜“é¢‘ç‡æ§åˆ¶

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### ç´¢å¼•ä¼˜åŒ–
```typescript
// ä¸»è¦ç´¢å¼•
player_tickets: ["uid", "templateId"]
ticket_transactions: ["uid", "templateId", "createdAt"]
ticket_templates: ["templateId", "type", "isActive"]
```

### æŸ¥è¯¢ä¼˜åŒ–
- ä½¿ç”¨ç´¢å¼•è¿›è¡Œå¿«é€ŸæŸ¥è¯¢
- åˆ†é¡µæŸ¥è¯¢å¤§é‡æ•°æ®
- ç¼“å­˜å¸¸ç”¨æ•°æ®

### æ‰¹é‡æ“ä½œ
- æ‰¹é‡å‘æ”¾å¥–åŠ±
- æ‰¹é‡æ›´æ–°ç»Ÿè®¡
- æ‰¹é‡æŸ¥è¯¢ç©å®¶é—¨ç¥¨

## ğŸš¨ é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯
```typescript
// é—¨ç¥¨ä¸å­˜åœ¨
{ success: false, message: "é—¨ç¥¨ä¸å­˜åœ¨" }

// æ•°é‡ä¸è¶³
{ success: false, message: "é—¨ç¥¨æ•°é‡ä¸è¶³" }

// ä»Šæ—¥ä½¿ç”¨æ¬¡æ•°å·²è¾¾ä¸Šé™
{ success: false, message: "ä»Šæ—¥ä½¿ç”¨æ¬¡æ•°å·²è¾¾ä¸Šé™" }

// ä¸é€‚ç”¨äºæ­¤æ¸¸æˆç±»å‹
{ success: false, message: "é—¨ç¥¨ä¸é€‚ç”¨äºæ­¤æ¸¸æˆç±»å‹" }
```

### é”™è¯¯æ¢å¤
- è‡ªåŠ¨é‡è¯•æœºåˆ¶
- äº‹åŠ¡å›æ»š
- é”™è¯¯æ—¥å¿—è®°å½•

## ğŸ”„ æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°é—¨ç¥¨ç±»å‹
1. åœ¨`ticket_templates`è¡¨ä¸­æ·»åŠ æ–°æ¨¡æ¿
2. æ›´æ–°åˆå§‹åŒ–è„šæœ¬
3. æ·»åŠ ç›¸åº”çš„APIæ¥å£

### æ·»åŠ æ–°æ¸¸æˆç±»å‹
1. åœ¨é—¨ç¥¨æ¨¡æ¿çš„`gameTypes`æ•°ç»„ä¸­æ·»åŠ æ–°æ¸¸æˆ
2. æ›´æ–°éªŒè¯é€»è¾‘
3. æµ‹è¯•æ–°æ¸¸æˆçš„é—¨ç¥¨ä½¿ç”¨

### è‡ªå®šä¹‰ä»·æ ¼ç­–ç•¥
1. ä¿®æ”¹é—¨ç¥¨æ¨¡æ¿çš„ä»·æ ¼é…ç½®
2. æ›´æ–°å¥—é¤ä»·æ ¼
3. è°ƒæ•´å¥–åŠ±å‘æ”¾é€»è¾‘

## ğŸ“ æœ€ä½³å®è·µ

### å¼€å‘å»ºè®®
1. **ç®€åŒ–è®¾è®¡**ï¼šä¿æŒç³»ç»Ÿç®€å•æ˜“æ‡‚
2. **ç»Ÿä¸€æ¥å£**ï¼šä½¿ç”¨ä¸€è‡´çš„APIè®¾è®¡
3. **å……åˆ†æµ‹è¯•**ï¼šè¦†ç›–æ‰€æœ‰ä½¿ç”¨åœºæ™¯
4. **æ–‡æ¡£å®Œå–„**ï¼šä¿æŒæ–‡æ¡£æ›´æ–°

### è¿è¥å»ºè®®
1. **ç›‘æ§ç³»ç»Ÿ**ï¼šå®šæœŸæ£€æŸ¥ç³»ç»ŸçŠ¶æ€
2. **æ•°æ®åˆ†æ**ï¼šåˆ†æé—¨ç¥¨ä½¿ç”¨æƒ…å†µ
3. **ç”¨æˆ·åé¦ˆ**ï¼šæ”¶é›†ç”¨æˆ·ä½¿ç”¨åé¦ˆ
4. **æŒç»­ä¼˜åŒ–**ï¼šæ ¹æ®æ•°æ®è°ƒæ•´ç­–ç•¥

### ç»´æŠ¤å»ºè®®
1. **å®šæœŸæ£€æŸ¥**ï¼šæ£€æŸ¥é—¨ç¥¨ä½¿ç”¨æƒ…å†µ
2. **å¤‡ä»½æ•°æ®**ï¼šå®šæœŸå¤‡ä»½é‡è¦æ•°æ®
3. **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡
4. **å®‰å…¨å®¡è®¡**ï¼šå®šæœŸè¿›è¡Œå®‰å…¨å®¡è®¡

## ğŸ¯ æ€»ç»“

ç®€åŒ–é—¨ç¥¨ç³»ç»Ÿé€šè¿‡ä¸‰ç§åŸºæœ¬ç±»å‹ï¼ˆé’é“œã€ç™½é“¶ã€é»„é‡‘ï¼‰å’Œæ— æ—¶æ•ˆè®¾è®¡ï¼Œä¸ºç©å®¶æä¾›äº†æ¸…æ™°æ˜“æ‡‚çš„é—¨ç¥¨ä½“ç³»ã€‚é—¨ç¥¨æœ¬èº«æ²¡æœ‰è¿‡æœŸæ—¶é—´ï¼Œæ°¸ä¹…æœ‰æ•ˆï¼Œè€Œé”¦æ ‡èµ›é…ç½®å†³å®šä½¿ç”¨å“ªç§é—¨ç¥¨ç±»å‹ï¼Œè¿™ç§è®¾è®¡æ›´åŠ çµæ´»å’Œç”¨æˆ·å‹å¥½ã€‚ç³»ç»Ÿè®¾è®¡ç®€æ´ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•ï¼ŒåŒæ—¶ä¿è¯äº†æ¸¸æˆçš„å¹³è¡¡æ€§å’Œå…¬å¹³æ€§ã€‚

### è®¾è®¡ä¼˜åŠ¿
1. **ç”¨æˆ·å‹å¥½**ï¼šé—¨ç¥¨ä¸ä¼šè¿‡æœŸï¼Œç”¨æˆ·ä¸ç”¨æ‹…å¿ƒæ—¶é—´é™åˆ¶
2. **çµæ´»é…ç½®**ï¼šé”¦æ ‡èµ›å¯ä»¥çµæ´»é…ç½®éœ€è¦çš„é—¨ç¥¨ç±»å‹
3. **ç®€åŒ–ç®¡ç†**ï¼šæ— éœ€ç®¡ç†å¤æ‚çš„æ—¶æ•ˆé€»è¾‘
4. **é™ä½æˆæœ¬**ï¼šå‡å°‘è¿‡æœŸé—¨ç¥¨çš„æ¸…ç†å’Œç»´æŠ¤æˆæœ¬ 